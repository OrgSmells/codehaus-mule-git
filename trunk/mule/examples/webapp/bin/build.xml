<?xml version="1.0" encoding="UTF-8"?>

<!--
 $Id: build.xml 3100 2006-09-19 01:37:58Z tcarlson $
 ======================================================================================
 Copyright (c) MuleSource, Inc.  All rights reserved.  http://www.mulesource.com

 The software in this package is published under the terms of the BSD style
 license, a copy of which has been included with this distribution in the
 LICENSE.txt file.
-->

<project name="Mule Examples: WebApp" default="compile" basedir="..">

    <property name="dir.src" value="src"/>
    <property name="dir.classes" value="classes"/>

    <target name="clean"
            description="Clean all compiled resources (start from scratch).">
        <delete file="mule-webapp.war"/>
    </target>

    <target name="sanity.check">
        <property environment="env"/>
        <property name="dir.mule.home" value="${env.MULE_HOME}"/>
        <echo>Mule home is set to ${env.MULE_HOME}</echo>
        <fail message="MULE_HOME environment variable has not been set.">
            <condition>
                <!--
                    Using a trick here. If there was no MULE_HOME environment variable set,
                    ant will set the value to the unprocessed template string
                -->
                <equals arg1="${dir.mule.home}" arg2="$${env.MULE_HOME}"/>
            </condition>
        </fail>
    </target>

    <target name="init"
            depends="sanity.check">

        <mkdir dir="${dir.classes}"/>
        <!-- Configure Mule classpath (mirrors wrapper.conf settings -->
        <path id="classpath.mule">
            <pathelement location="${dir.mule.home}/conf"/>
            <fileset dir="${dir.mule.home}/lib/user">
                <include name="**/*.jar"/>
            </fileset>
            <fileset dir="${dir.mule.home}/lib/mule">
                <include name="**/*.jar"/>
            </fileset>
            <fileset dir="${dir.mule.home}/lib/opt">
                <include name="**/*.jar"/>
            </fileset>
            <fileset dir="${dir.mule.home}/lib">
                <include name="**/*.jar"/>
            </fileset>
        </path>
    </target>

    <target name="compile"
            depends="init"
            description="Compile the example application.">

        <javac srcdir="${dir.src}"
               destdir="${dir.classes}"
               debug="true"
               source="1.4"
               target="1.4">
            <classpath refid="classpath.mule"/>
        </javac>
        <!-- Copy all resources to the output folder as well -->
        <copy todir="${dir.classes}">
            <fileset dir="${dir.src}">
                <exclude name="**/*.java"/>
            </fileset>
        </copy>

        <war destfile="mule-webapp.war" webxml="conf/web.xml">
            <lib dir="${dir.mule.home}/lib/user">
                <include name="**/*.jar"/>
            </lib>
            <lib dir="${dir.mule.home}/lib/mule">
                <include name="**/*.jar"/>
            </lib>
            <lib dir="${dir.mule.home}/lib/opt">
                <include name="**/*.jar"/>
                <exclude name="geronimo-spec-servlet*"/>
            </lib>
            <classes dir="classes"/>
            <fileset dir="webapp"/>
            <webinf dir="conf"/>
        </war>
    </target>

</project>
