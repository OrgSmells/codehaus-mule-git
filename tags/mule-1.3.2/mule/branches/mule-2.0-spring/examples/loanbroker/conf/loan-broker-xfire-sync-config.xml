<?xml version="1.0" encoding="UTF-8"?>

<!DOCTYPE mule-configuration PUBLIC "-//MuleSource //DTD mule-configuration XML V1.0//EN"
                                "http://mule.mulesource.org/dtds/mule-configuration.dtd">

<mule-configuration id="Mule_Loan_broker_Synchronous_Sample" version="1.0">
    <description>
    This loan broker example is modeled on the Enterprise integration Patterns book
    sample.
    This implementation differs in that this configuration uses an synchronous
    model where each component is invoked from the LoanBroker component.
    </description>

    <mule-environment-properties synchronous="true"/>

<!--    <agents>-->
        <!-- starts an RMI registry on the default port 1099 for JMX Remoting and then sets up
             all the default Jmx support agents in Mule -->
<!--        <agent name="JMX" className="org.mule.management.agents.DefaultJmxSupportAgent"/>-->
<!--    </agents>-->

    <global-endpoints>

        <endpoint name="LoanBrokerRequests" address="vm://LoanBrokerRequests"/>
        <endpoint name="LoanBrokerQuotes" address="vm://LoanQuotes"/>
        <endpoint name="CreditAgency" address="xfire:http://localhost:18080/mule/CreditAgencyService?method=getCreditProfile"/>
        <endpoint name="CreditAgencyReceiver" address="xfire:http://localhost:18080/mule"/>
        <endpoint name="LenderServiceEndpoint" address="vm://LenderService?method=setLenderList"/>
        <!-- The method parameter for the bank endpoints is added programmitcally when the bank objects are
        created -->
        <endpoint name="Bank1Endpoint" address="xfire:http://localhost:10080/mule"/>
        <endpoint name="Bank2Endpoint" address="xfire:http://localhost:20080/mule"/>
        <endpoint name="Bank3Endpoint" address="xfire:http://localhost:30080/mule"/>
        <endpoint name="Bank4Endpoint" address="xfire:http://localhost:40080/mule"/>
        <endpoint name="Bank5Endpoint" address="xfire:http://localhost:50080/mule"/>
    </global-endpoints>

    <model name="loan-broker">
        <mule-descriptor name="LoanBroker"
            implementation="org.mule.samples.loanbroker.SyncLoanBroker">
            <inbound-router>
                <global-endpoint name="LoanBrokerRequests"/>
            </inbound-router>

            <outbound-router>
                <router className="org.mule.routing.outbound.FilteringOutboundRouter">
                    <global-endpoint name="CreditAgency"/>
                    <filter expression="/loanRequest/creditProfile = null" className="org.mule.routing.filters.xml.JXPathFilter"/>
                </router>
                <router className="org.mule.routing.outbound.FilteringOutboundRouter">
                    <global-endpoint name="LenderServiceEndpoint"/>
                    <filter expression="/lenders = null" className="org.mule.routing.filters.xml.JXPathFilter"/>
                </router>
            </outbound-router>
            <response-router timeout="10000">
                <global-endpoint name="LoanBrokerQuotes"/>
                <router className="org.mule.samples.loanbroker.routers.BankQuotesResponseAggregator"/>
            </response-router>
        </mule-descriptor>

        <mule-descriptor name="CreditAgencyService" implementation="org.mule.samples.loanbroker.DefaultCreditAgencyService">
            <inbound-router>
                <global-endpoint name="CreditAgencyReceiver"/>
            </inbound-router>
        </mule-descriptor>

        <mule-descriptor name="LenderService" implementation="org.mule.samples.loanbroker.DefaultLenderService">
            <inbound-router>
                <global-endpoint name="LenderServiceEndpoint"/>
            </inbound-router>
            <outbound-router>
                <router className="org.mule.routing.outbound.StaticRecipientList">
                    <reply-to address="LoanBrokerQuotes"/>
                    <filter expression="recipients!=null" className="org.mule.routing.filters.MessagePropertyFilter"/>
                </router>
            </outbound-router>
        </mule-descriptor>

        <mule-descriptor name="Bank1" implementation="org.mule.samples.loanbroker.Bank">
            <inbound-router>
                <global-endpoint name="Bank1Endpoint"/>
            </inbound-router>
        </mule-descriptor>

        <mule-descriptor name="Bank2" implementation="org.mule.samples.loanbroker.Bank">
            <inbound-router>
                <global-endpoint name="Bank2Endpoint"/>
            </inbound-router>
        </mule-descriptor>

        <mule-descriptor name="Bank3" implementation="org.mule.samples.loanbroker.Bank">
            <inbound-router>
                <global-endpoint name="Bank3Endpoint"/>
            </inbound-router>
        </mule-descriptor>

        <mule-descriptor name="Bank4" implementation="org.mule.samples.loanbroker.Bank">
            <inbound-router>
                <global-endpoint name="Bank4Endpoint"/>
            </inbound-router>
        </mule-descriptor>

        <mule-descriptor name="Bank5" implementation="org.mule.samples.loanbroker.Bank">
            <inbound-router>
                <global-endpoint name="Bank5Endpoint"/>
            </inbound-router>
        </mule-descriptor>
    </model>
</mule-configuration>
