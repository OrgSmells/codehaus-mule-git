<?xml version="1.0" encoding="UTF-8"?>

<!DOCTYPE mule-configuration PUBLIC "-//MuleSource //DTD mule-configuration XML V1.0//EN"
                                "http://mule.mulesource.org/dtds/mule-configuration.dtd">

<mule-configuration id="Mule_Loan_broker_Synchronous_Sample" version="1.0">
    <description>
    This loan broker example is modeled on the Enterprise integration Patterns book
    sample.
    This implementation differs in that this configuration uses an synchronous
    model where each component is invoked from the LoanBroker component.
    </description>

    <mule-environment-properties synchronous="true" serverUrl=""/>

    <!-- for some reason Axis auto typing doesn't always work and you need to define the top-level
    bean types for the objects you're passing around -->
    <connector name="axisConnector" className="org.mule.providers.soap.axis.AxisConnector">
        <properties>
            <list name="beanTypes">
                <entry value="org.mule.examples.loanbroker.messages.CreditProfile"/>
                <entry value="org.mule.examples.loanbroker.messages.Customer"/>
                <entry value="org.mule.examples.loanbroker.messages.CustomerQuoteRequest"/>
                <entry value="org.mule.examples.loanbroker.messages.LoanBrokerQuoteRequest"/>
                <entry value="org.mule.examples.loanbroker.messages.LoanQuote"/>
            </list>
        </properties>
    </connector>

	<!-- TODO Move these to global-endpoints once MULE-1464 is fixed. -->
    <endpoint-identifiers>
        <endpoint-identifier name="CustomerRequests" value="vm://customer.requests"/>
        <endpoint-identifier name="LoanBrokerQuotes" value="vm://loan.quotes"/>
        <endpoint-identifier name="CreditAgency" value="axis:http://localhost:18080/mule/CreditAgencyService?method=getCreditProfile"/>
        <endpoint-identifier name="CreditAgencyIn" value="axis:http://localhost:18080/mule"/>
        <endpoint-identifier name="LenderService" value="vm://lender.service?method=setLenderList"/>
        <endpoint-identifier name="BankGateway" value="vm://bank.gateway"/>
    </endpoint-identifiers>

    <transformers>
    	<transformer name="ExtractCustomer" className="org.mule.transformers.simple.GetBeanProperty">
    		<properties>
    			<property name="field" value="customerRequest.customer" />
    		</properties>
    	</transformer>
        <transformer name="SetLendersAsRecipients" className="org.mule.examples.loanbroker.transformers.SetLendersAsRecipients" />
    </transformers>
    
    <global-endpoints>
        <endpoint name="Bank1" address="axis:http://localhost:10080/mule/Bank1?method=getLoanQuote"/>
        <endpoint name="Bank2" address="axis:http://localhost:20080/mule/Bank2?method=getLoanQuote"/>
        <endpoint name="Bank3" address="axis:http://localhost:30080/mule/Bank3?method=getLoanQuote"/>
        <endpoint name="Bank4" address="axis:http://localhost:40080/mule/Bank4?method=getLoanQuote"/>
        <endpoint name="Bank5" address="axis:http://localhost:50080/mule/Bank5?method=getLoanQuote"/>
        <endpoint name="Bank1In" address="axis:http://localhost:10080/mule"/>
        <endpoint name="Bank2In" address="axis:http://localhost:20080/mule"/>
        <endpoint name="Bank3In" address="axis:http://localhost:30080/mule"/>
        <endpoint name="Bank4In" address="axis:http://localhost:40080/mule"/>
        <endpoint name="Bank5In" address="axis:http://localhost:50080/mule"/>
    </global-endpoints>
    
    <model name="loan-broker">
        <mule-descriptor name="LoanBroker"
        inboundEndpoint="CustomerRequests"
            implementation="org.mule.examples.loanbroker.esn.SynchronousLoanBroker">
            <outbound-router>
                <router className="org.mule.routing.outbound.FilteringOutboundRouter">
                    <endpoint address="CreditAgency" transformers="ExtractCustomer"/>
                    <filter expression="/creditProfile = null" className="org.mule.routing.filters.xml.JXPathFilter"/>
                </router>
                <router className="org.mule.routing.outbound.FilteringOutboundRouter">
                    <endpoint address="LenderService"/>
                    <filter expression="/lenders = null" className="org.mule.routing.filters.xml.JXPathFilter"/>
                </router>
            </outbound-router>
            <response-router timeout="10000">
                <endpoint address="LoanBrokerQuotes"/>
                <router className="org.mule.examples.loanbroker.routers.BankQuotesResponseAggregator"/>
            </response-router>
        </mule-descriptor>

        <!--
        The credit agency service will get the credit profile for a customer
        -->
        <mule-descriptor name="CreditAgencyService"
            			 implementation="org.mule.examples.loanbroker.credit.DefaultCreditAgency">
            <inbound-router>
                <endpoint address="CreditAgencyIn"/>
            </inbound-router>
        </mule-descriptor>

        <!--
        The Lender service is used to determine which banks to contact for a quote
        -->
        <mule-descriptor name="LenderService"
        inboundEndpoint="LenderService"
            			 implementation="org.mule.examples.loanbroker.lender.DefaultLender">
            <outbound-router>
                <router className="org.mule.routing.outbound.FilteringOutboundRouter">
                    <endpoint address="BankGateway" transformers="SetLendersAsRecipients"/>
                </router>
            </outbound-router>
        </mule-descriptor>
            
        <mule-descriptor name="BankGateway"
        inboundEndpoint="BankGateway"
            			 implementation="org.mule.components.simple.BridgeComponent">
            <outbound-router>
                <catch-all-strategy className="org.mule.routing.LoggingCatchAllStrategy"/>
                <router className="org.mule.routing.outbound.StaticRecipientList">
                    <reply-to address="LoanBrokerQuotes"/>
                    <filter expression="recipients!=null" className="org.mule.routing.filters.MessagePropertyFilter"/>
                </router>
            </outbound-router>
        </mule-descriptor>

        <mule-descriptor name="Bank1" implementation="org.mule.examples.loanbroker.bank.Bank">
            <inbound-router>
                <global-endpoint name="Bank1In"/>
            </inbound-router>
        </mule-descriptor>

        <mule-descriptor name="Bank2" implementation="org.mule.examples.loanbroker.bank.Bank">
            <inbound-router>
                <global-endpoint name="Bank2In"/>
            </inbound-router>
        </mule-descriptor>

        <mule-descriptor name="Bank3" implementation="org.mule.examples.loanbroker.bank.Bank">
            <inbound-router>
                <global-endpoint name="Bank3In"/>
            </inbound-router>
        </mule-descriptor>

        <mule-descriptor name="Bank4" implementation="org.mule.examples.loanbroker.bank.Bank">
            <inbound-router>
                <global-endpoint name="Bank4In"/>
            </inbound-router>
        </mule-descriptor>

        <mule-descriptor name="Bank5" implementation="org.mule.examples.loanbroker.bank.Bank">
            <inbound-router>
                <global-endpoint name="Bank5In"/>
            </inbound-router>
        </mule-descriptor>
    </model>
</mule-configuration>
